<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Mendel F1 Hybrid</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    table {
      border-collapse: collapse;
    }
    td {
      border: 1px solid #333;
      padding: 0.5rem;
      text-align: center;
      width: 3rem;
      height: 3rem;
    }
    .color-box {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Anzahl Gene: {{ n }}</h1>
    <h2>F1 Hybrid Selbstung</h2>
    <p>{{ f1HybridString() }} &#215; {{ f1HybridString() }}</p>
    <div>
        <button @click="showGenotype">Genotyp</button>        
        <button @click="showPhenotype">Phänotyp</button>        
    </div>
    <table>
      <tr v-for="i in rows" :key="i">
        <td v-for="j in cols" :key="j">
          {{ cellContent(i-1, j-1) }} <br>
          <div
          v-if="i !== 1 && j !== 1"
          class="color-box"
          :style="{ backgroundColor: rgbColor(i-1, j-1) }"
          :title="cellContent(i-1, j-1)"
        ></div>
        </td>
      </tr>
    </table>
    <button @click="incN">Erhöhe</button>
    <button @click="decN">Erniedrige</button>
  </div>
  <script>
    const { createApp, ref, computed } = Vue;

    createApp({
      setup() {
        const n = ref(1)
        const rows = computed(() => 1 + 2 ** n.value);
        const cols = ref(rows);

        const PHENOTYPE = 1
        const GENOTYPE = 2

        const showtype = ref(GENOTYPE)

        const A = x => String.fromCharCode(64 + x); //1->A, 2->B
        const a = x => String.fromCharCode(96 + x); //1->a, 2->b

        const f1HybridString = () => {
            let s = "";
            for (let k = 1; k <= n.value; ++k) {
                s += A(k) + a(k)
            }
            return s;
        }

        const cellContent = (i, j) => {


            if (i > j) {
                [i, j] = [j, i];
            }
          
            if (i == 0) {
                if (j == 0) {
                    return "";
                }
                j--;
                let s = "";
                for (let k = 1; k <= n.value; ++k) {
                    const bit = j & 1;
                    if (bit == 0) 
                        s += A(k);
                    else
                        s += a(k);
                    j >>= 1;
                }
                return s;
            }

            i--;
            j--;
            let s = "";
            for (let k = 1; k <= n.value; ++k) {
                const ibit = i & 1;
                i >>= 1;
                const jbit = j & 1;
                j >>= 1;
                switch(ibit + jbit) {
                    case 0:
                        s += A(k) + A(k);
                        break;
                    case 1:
                        s += A(k) + a(k);
                        break;
                    case 2:
                        s += a(k) + a(k);
                        break;
                }
            }

            return s;

            // Beispiel: Summe der Koordinaten
            return i + j;
        };

        const getColorGenotyp = (i, j) => {
            const maxValue = 2 ** (2 * n.value);
            const genotyp = cellContent(i, j);
            let v = 0;
            for (let x of genotyp) {
                if (x.charCodeAt(0) >= 97) {
                    v++;
                }
                v <<= 1;
            }
            const value_latent = v >> 1;
            const value_normal = value_latent / maxValue;
            return value_normal;
        }

        const getColorPhenotyp = (i, j) => {
            const maxValue = 2 ** n.value;
            const genotyp = cellContent(i, j);
            let v = 0;
            for (let i = 0; i < genotyp.length; i += 2) {
                if (genotyp.charCodeAt(i) < 97 ||
                    genotyp.charCodeAt(i + 1) < 97) {
                    v++;
                }
                v <<= 1;                
            }

            const value_latent = v >> 1;
            const value_normal = value_latent / maxValue;
            return value_normal;
        }

        const getColor = (i, j) => {
            switch(showtype.value) {
                case GENOTYPE:
                    return getColorGenotyp(i, j);
                case PHENOTYPE:
                    return getColorPhenotyp(i, j);
            }
        }

        const grayColor = (i, j) => {
          const value = getColor(i, j);
          const gray = Math.round(value * 255);
          return `rgb(${gray}, ${gray}, ${gray})`;
        };

        const rgbColor = (i, j) => {
            const value = getColor(i, j); // 0..1
            const scaled = value * 6;        // 0..6 für 6 Abschnitte
            const section = Math.floor(scaled);
            const t = scaled - section;      // Interpolation in Abschnitt

            let r = 0, g = 0, b = 0;

            switch (section) {
                case 0: r = 255; g = Math.round(255 * t); b = 0; break;         // rot → gelb
                case 1: r = Math.round(255 * (1 - t)); g = 255; b = 0; break;   // gelb → grün
                case 2: r = 0; g = 255; b = Math.round(255 * t); break;        // grün → cyan
                case 3: r = 0; g = Math.round(255 * (1 - t)); b = 255; break;  // cyan → blau
                case 4: r = Math.round(255 * t); g = 0; b = 255; break;        // blau → magenta
                case 5: r = 255; g = 0; b = Math.round(255 * (1 - t)); break;  // magenta → rot
            }

            return `rgb(${r}, ${g}, ${b})`;
        };



        const incN = () => {
            n.value++;
        }
        const decN = () => {
            if (n.value <= 1) return;
            n.value--;
        }

        const showGenotype = () => {
            showtype.value = GENOTYPE;
        }

        const showPhenotype = () => {
            showtype.value = PHENOTYPE;
        }

        return {
            n, rows, cols, 
            cellContent, incN, decN, 
            grayColor, rgbColor, f1HybridString,
            showGenotype, showPhenotype
         };
      }
    }).mount('#app');
  </script>
</body>
</html>
